name: Memos Web Production Build (Fixed)

on:
  push:
    branches: [ "main" ]
    paths:
      - 'web/**'
      - '.github/workflows/web-build.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    # 深度检出包含完整历史记录
    - name: Checkout repository (full history)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 关键修复：获取完整提交历史
        path: 'repo'    # 指定检出目录

    # 确认目录结构
    - name: Verify repository structure
      run: |
        echo "Current directory: $(pwd)"
        echo "Repository contents:"
        ls -la repo/
        echo "Web directory contents:"
        ls -la repo/web/
        if [ ! -f "repo/web/yarn.lock" ]; then
          echo "::error::yarn.lock missing in repo/web directory!"
          exit 1
        fi

    # 设置工作目录环境变量
    - name: Setup environment
      run: echo "WORKSPACE=$(pwd)/repo" >> $GITHUB_ENV

    # Node.js 环境设置（明确指向锁定文件）
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'
        cache-dependency-path: '${{ env.WORKSPACE }}/web/yarn.lock'

    # 安装依赖（严格模式）
    - name: Install dependencies
      working-directory: ${{ env.WORKSPACE }}/web
      run: |
        yarn set version 3.6.3
        yarn config set enableImmutableInstalls true
        yarn install --immutable
        echo "Lockfile validation passed"

    # 生产环境构建
    - name: Build production assets
      working-directory: ${{ env.WORKSPACE }}/web
      run: |
        yarn build
        echo "Build output size:"
        du -sh dist/

    # 上传制品
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: memos-web-assets
        path: ${{ env.WORKSPACE }}/web/dist/*
        retention-days: 3
